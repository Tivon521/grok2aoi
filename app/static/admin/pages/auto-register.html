<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨æ³¨å†Œ - Grok2API Ultimate</title>
    <link rel="stylesheet" href="/static/common/css/common.css">
    <link rel="stylesheet" href="/static/admin/css/token.css">
    <style>
        .auto-register-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .config-item {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .config-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .config-value {
            color: #6c757d;
            font-family: monospace;
        }
        
        .register-form {
            margin-top: 24px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn-register {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-register:hover {
            background: #0056b3;
        }
        
        .btn-register:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .result-box {
            margin-top: 24px;
            padding: 16px;
            border-radius: 4px;
            display: none;
        }
        
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>
    
    <div class="container">
        <h1>ğŸ¤– è‡ªåŠ¨æ³¨å†Œ Token</h1>
        
        <div class="auto-register-section">
            <h2>åŠŸèƒ½çŠ¶æ€</h2>
            <div id="status-container">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <div class="auto-register-section" id="register-section" style="display: none;">
            <h2>æ‰¹é‡æ³¨å†Œ</h2>
            <div class="register-form">
                <div class="form-group">
                    <label for="count">æ³¨å†Œæ•°é‡</label>
                    <input type="number" id="count" min="1" max="1000" value="10" placeholder="è¾“å…¥è¦æ³¨å†Œçš„è´¦å·æ•°é‡">
                </div>
                
                <div class="form-group">
                    <label for="concurrency">å¹¶å‘æ•°</label>
                    <input type="number" id="concurrency" min="1" max="50" value="5" placeholder="åŒæ—¶æ³¨å†Œçš„è´¦å·æ•°">
                </div>
                
                <button class="btn-register" id="btn-register" onclick="startRegister()">
                    å¼€å§‹æ³¨å†Œ
                </button>
                
                <div class="result-box" id="result-box"></div>
            </div>
        </div>
        
        <div class="auto-register-section">
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <ol>
                <li>ç¡®ä¿å·²åœ¨ <code>data/config.toml</code> ä¸­å¯ç”¨è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½</li>
                <li>é…ç½® Turnstile Solver æˆ– YesCaptcha API Key</li>
                <li>è®¾ç½®é‚®ç®±åŸŸåå’Œå·¥ä½œåŸŸå</li>
                <li>ç‚¹å‡»"å¼€å§‹æ³¨å†Œ"æ‰¹é‡åˆ›å»ºè´¦å·</li>
                <li>æ³¨å†ŒæˆåŠŸçš„ Token ä¼šè‡ªåŠ¨æ·»åŠ åˆ° Token æ± </li>
            </ol>
            
            <h3>é…ç½®ç¤ºä¾‹</h3>
            <pre style="background: #f8f9fa; padding: 16px; border-radius: 4px; overflow-x: auto;">
[register]
enabled = true
worker_domain = "grok.com"
email_domain = "example.com"
solver_url = "http://localhost:5000"
default_count = 100
default_concurrency = 10
yescaptcha_client_key = ""  # å¯é€‰
            </pre>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>
    
    <script src="/static/common/js/header.js"></script>
    <script src="/static/common/js/footer.js"></script>
    <script src="/static/common/js/admin-auth.js"></script>
    <script>
        let isRegistering = false;
        
        async function loadStatus() {
            try {
                const response = await fetch('/api/v1/admin/auto-register/status', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('api_key')}`
                    }
                });
                
                const data = await response.json();
                
                const statusHtml = `
                    <div class="config-item">
                        <div class="config-label">çŠ¶æ€</div>
                        <div class="config-value">
                            <span class="status-badge ${data.enabled ? 'status-enabled' : 'status-disabled'}">
                                ${data.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}
                            </span>
                        </div>
                    </div>
                    ${data.enabled ? `
                        <div class="config-item">
                            <div class="config-label">å·¥ä½œåŸŸå</div>
                            <div class="config-value">${data.config.worker_domain || 'æœªé…ç½®'}</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">é‚®ç®±åŸŸå</div>
                            <div class="config-value">${data.config.email_domain || 'æœªé…ç½®'}</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">Solver URL</div>
                            <div class="config-value">${data.config.solver_url || 'æœªé…ç½®'}</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">YesCaptcha</div>
                            <div class="config-value">${data.config.has_yescaptcha ? 'å·²é…ç½®' : 'æœªé…ç½®'}</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">é»˜è®¤æ•°é‡</div>
                            <div class="config-value">${data.config.default_count}</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">é»˜è®¤å¹¶å‘</div>
                            <div class="config-value">${data.config.default_concurrency}</div>
                        </div>
                    ` : `
                        <p style="margin-top: 16px; color: #721c24;">
                            è¯·åœ¨ <code>data/config.toml</code> ä¸­è®¾ç½® <code>register.enabled = true</code> å¯ç”¨æ­¤åŠŸèƒ½
                        </p>
                    `}
                `;
                
                document.getElementById('status-container').innerHTML = statusHtml;
                
                if (data.enabled) {
                    document.getElementById('register-section').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('status-container').innerHTML = `
                    <p style="color: #721c24;">åŠ è½½å¤±è´¥: ${error.message}</p>
                `;
            }
        }
        
        async function startRegister() {
            if (isRegistering) return;
            
            const count = parseInt(document.getElementById('count').value);
            const concurrency = parseInt(document.getElementById('concurrency').value);
            
            if (!count || count < 1 || count > 1000) {
                showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„æ³¨å†Œæ•°é‡ (1-1000)', false);
                return;
            }
            
            if (!concurrency || concurrency < 1 || concurrency > 50) {
                showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„å¹¶å‘æ•° (1-50)', false);
                return;
            }
            
            isRegistering = true;
            const btn = document.getElementById('btn-register');
            btn.disabled = true;
            btn.innerHTML = 'æ³¨å†Œä¸­<span class="loading"></span>';
            
            try {
                const response = await fetch('/api/v1/admin/auto-register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('api_key')}`
                    },
                    body: JSON.stringify({ count, concurrency })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`âœ… ${data.message}`, true);
                    setTimeout(() => {
                        window.location.href = '/admin/token';
                    }, 2000);
                } else {
                    showResult(`âŒ ${data.message}`, false);
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            } finally {
                isRegistering = false;
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹æ³¨å†Œ';
            }
        }
        
        function showResult(message, success) {
            const resultBox = document.getElementById('result-box');
            resultBox.className = 'result-box ' + (success ? 'result-success' : 'result-error');
            resultBox.textContent = message;
            resultBox.style.display = 'block';
            
            setTimeout(() => {
                resultBox.style.display = 'none';
            }, 5000);
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–çŠ¶æ€
        loadStatus();
    </script>
</body>
</html>
